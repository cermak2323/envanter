#!/usr/bin/env python
"""
Render.com PostgreSQL - T√ºm Veritabanlarƒ±nƒ± Kontrol Et ve Restore Se√ßeneklerini G√∂ster
"""

from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import text
import datetime

DATABASE_URL = "postgresql://cermak_user:XPNP4Yt8dsWdKaaxNlQOzIiRJjWoTrfC@dpg-d2m6l5ripnbc738v4b0g-a.oregon-postgres.render.com:5432/cermak?sslmode=require"

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = DATABASE_URL
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)

with app.app_context():
    try:
        print("\n" + "=" * 120)
        print("üíæ RENDER.COM PostgreSQL - RECOVERY VE BACKUP ANALƒ∞Zƒ∞")
        print("=" * 120 + "\n")
        
        # 1. Veritabanƒ± Bilgileri
        print("1Ô∏è‚É£  VERƒ∞TABANI Bƒ∞LGƒ∞LERƒ∞")
        print("-" * 120)
        
        query = text("""
            SELECT 
                datname
            FROM pg_database
            WHERE datname NOT IN ('template0', 'template1', 'postgres')
            ORDER BY datname
        """)
        
        dbs = db.session.execute(query).fetchall()
        
        for datname, in dbs:
            print(f"  üì¶ {datname}")
        print()
        
        # 2. Users tablosu - T√ºm Veriler
        print("\n2Ô∏è‚É£  USERS TABLOSU - FULL BACKUP")
        print("-" * 120)
        
        query_users = text("""
            SELECT 
                id, username, password, password_hash, full_name, role,
                created_at, real_name, email, job_title, is_active_user
            FROM users
            ORDER BY id
        """)
        
        users = db.session.execute(query_users).fetchall()
        
        print(f"‚úÖ Toplam Kayƒ±t: {len(users)}\n")
        
        if users:
            # CSV formatƒ±nda kaydet
            csv_content = "id,username,password,password_hash,full_name,role,created_at,real_name,email,job_title,is_active_user\n"
            
            for user_id, username, password, password_hash, full_name, role, created_at, real_name, email, job_title, is_active in users:
                csv_content += f'{user_id},"{username}","{password}","{password_hash}","{full_name}","{role}","{created_at}","{real_name}","{email}","{job_title}",{is_active}\n'
                
                print(f"  ID: {user_id}")
                print(f"    ‚Ä¢ Username: {username}")
                print(f"    ‚Ä¢ Password: {password}")
                print(f"    ‚Ä¢ Full Name: {full_name}")
                print(f"    ‚Ä¢ Role: {role}")
                print()
            
            # CSV'yi kaydet
            with open("users_backup.csv", "w", encoding="utf-8") as f:
                f.write(csv_content)
            print(f"‚úÖ CSV Backup kaydedildi: users_backup.csv\n")
        
        # 3. T√ºm Tablolarƒ±n ƒ∞√ßeriƒüi
        print("\n3Ô∏è‚É£  T√úM TABLOLARIN SAYILARI")
        print("-" * 120)
        
        query_tables = text("""
            SELECT 
                schemaname,
                tablename,
                (SELECT COUNT(*) FROM information_schema.columns 
                 WHERE table_schema = schemaname AND table_name = tablename) as column_count
            FROM pg_tables
            WHERE schemaname = 'public'
            ORDER BY tablename
        """)
        
        tables = db.session.execute(query_tables).fetchall()
        
        for schema, tablename, col_count in tables:
            count_query = text(f"SELECT COUNT(*) FROM {tablename}")
            row_count = db.session.execute(count_query).scalar()
            
            print(f"  üìã {tablename:20} | Kolonlar: {col_count:3} | Satƒ±rlar: {row_count:5}")
        
        # 4. Tarih Bilgileri
        print("\n4Ô∏è‚É£  VERƒ∞ OLU≈ûTURULMA TARƒ∞HLERƒ∞")
        print("-" * 120)
        
        query_dates = text("""
            SELECT 
                tablename,
                (SELECT MIN(created_at) FROM users LIMIT 1) as first_user_created,
                (SELECT MAX(updated_at) FROM users LIMIT 1) as last_user_update,
                (SELECT COUNT(*) FROM users) as total_users
            FROM pg_tables
            WHERE tablename = 'users'
        """)
        
        date_info = db.session.execute(query_dates).fetchone()
        if date_info:
            print(f"  ƒ∞lk Kullanƒ±cƒ± Tarihi: {date_info[1]}")
            print(f"  Son G√ºncelleme: {date_info[2]}")
            print(f"  Toplam Kullanƒ±cƒ±: {date_info[3]}")
        
        # 5. RESTORE SE√áENEKLERI
        print("\n" + "=" * 120)
        print("üîß RESTORE VE RECOVERY SE√áENEKLERƒ∞")
        print("=" * 120 + "\n")
        
        print("‚ùå PROBLEM: Production'da sadece 2 kullanƒ±cƒ± var (admin, test1)")
        print("   Diƒüer ~8 kullanƒ±cƒ± nerede?")
        print()
        print("‚úÖ √á√ñZ√úM ADAYLARI:")
        print()
        print("1. Render.com BACKUP PORTAL'dan eski backup'ƒ± restore et:")
        print("   https://dashboard.render.com ‚Üí PostgreSQL ‚Üí Backups")
        print()
        print("2. Yerel SQLite'dan kullanƒ±cƒ±larƒ± import et:")
        print("   python migrate_from_sqlite.py")
        print()
        print("3. Eski kurulumlardaki verileri ara:")
        print("   SSH baƒülantƒ±sƒ± ile eski dizinleri kontrol et")
        print()
        print("4. Backup CSV'den restore et:")
        print("   COPY users FROM 'users_backup.csv' WITH CSV HEADER;")
        print()
        
        # 6. Suggest Commands
        print("\n" + "=" * 120)
        print("üìù TAVSIYE EDILEN KOMUTLAR")
        print("=" * 120 + "\n")
        
        print("# 1. PostgreSQL Dump Al (Production'dan)")
        print("""
pg_dump postgresql://cermak_user:PASSWORD@dpg-d2m6l5ripnbc738v4b0g-a.oregon-postgres.render.com:5432/cermak > cermak_backup.sql
""")
        
        print("\n# 2. Specific Users'ƒ± Al")
        print("""
psql postgresql://cermak_user:PASSWORD@dpg-d2m6l5ripnbc738v4b0g-a.oregon-postgres.render.com:5432/cermak -c "\\copy (SELECT * FROM users) TO users_full_backup.csv WITH CSV HEADER"
""")
        
        print("\n# 3. Restore √ñncesi Kontrol")
        print("""
psql postgresql://cermak_user:PASSWORD@dpg-d2m6l5ripnbc738v4b0g-a.oregon-postgres.render.com:5432/cermak -c "SELECT * FROM users"
""")
        
        print("\n" + "=" * 120)
        print("‚úÖ ANALƒ∞Z TAMAMLANDI")
        print("=" * 120 + "\n")
        
    except Exception as e:
        print(f"\n‚ùå Hata: {e}")
        import traceback
        traceback.print_exc()
